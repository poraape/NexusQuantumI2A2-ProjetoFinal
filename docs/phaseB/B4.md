# B4 — Canal Seguro UI ↔ Planner

## Objetivo
Prover comunicação bidirecional entre a SPA e o planner multiagente com
autenticação mTLS, suporte a feature flags e tolerância a falhas.

## Entregáveis
- `gateway/config.yaml` definindo certificados, tópicos e limites.
- `tests/integration/websocket.spec.mjs` validando handshake e troca de mensagens.
- Estratégia de reconexão documentada abaixo.

## Arquitetura
1. O navegador estabelece WebSocket seguro com o `EdgeGateway` usando token
   efêmero. O gateway exige mTLS para rotear mensagens internas.
2. Mensagens convertidas para `intent.envelope` e publicadas no bus.
3. Respostas do planner/agents retornam via tópico `planner.updates.v1` e são
   retransmitidas para a UI.

## Resiliência
- Reconnect exponencial com jitter (1s → 32s) e limite de 5 tentativas antes de
  degradação controlada.
- Heartbeat a cada 30s; ausência de 2 heartbeats dispara fallback para polling.
- Tokens de sessão renovados a cada 10 minutos.

## Próximos Passos
- Implementar proxy real no BFF (Fase C) com suporte a multiplexação de sessões.
- Expandir teste de integração para cobrir renegociação de certificados.
