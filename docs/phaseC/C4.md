# C4 — Batching Inteligente

## Objetivo
Implementar orquestração de lotes dinâmicos respeitando limites de tokens/modelos e evitando bloqueios.

## Entradas
- Configuração `scheduler/rules.yaml`
- Dados de workload em `benchmarks/perf/batching-baseline.json`
- Ferramentas de observabilidade (`metrics/base.prom`)

## Passos
1. Definir parâmetros `minBatchSize`, `maxBatchSize` e `maxWaitMs` em `scheduler/rules.yaml`.
2. Atualizar `adapters/plannerAdapter.ts` para emitir metadados `batchCandidate=true`.
3. Implementar consumer no agente ETL para aceitar lotes (feature flag `enableBatching`).
4. Validar limites via `tests/batching.spec.mjs` executando cenários de alto volume.
5. Monitorar métricas `batch_size_avg` e `batch_wait_ms` no dashboard `dashboards/agent-health.json`.

## Saídas
- `scheduler/rules.yaml` ajustado.
- `tests/batching.spec.mjs` com casos de sucesso/erro.
- Relatório `docs/phaseC/C4-report.md` com impacto nos KPIs.

## Critérios de Aceitação
- Throughput ↑ ≥25% comparado ao baseline.
- Nenhum lote excede limites de tokens/documentos.
- DLQ sem mensagens relacionadas a lotes por 7 dias.
